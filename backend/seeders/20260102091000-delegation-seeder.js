'use strict';

async function rowExists(queryInterface, Sequelize, { table, where }) {
  const dialect = queryInterface.sequelize.getDialect();
  const keys = Object.keys(where);
  const whereSql = keys.map(k => `${k} = :${k}`).join(' AND ');

  const sql = dialect === 'mssql'
    ? `SELECT TOP 1 1 as found FROM ${table} WHERE ${whereSql}`
    : `SELECT 1 as found FROM ${table} WHERE ${whereSql} LIMIT 1`;

  const rows = await queryInterface.sequelize.query(sql, {
    replacements: where,
    type: Sequelize.QueryTypes.SELECT,
  });

  return rows.length > 0;
}

async function findGouvIdByLibelle(queryInterface, Sequelize, libelle) {
  const dialect = queryInterface.sequelize.getDialect();
  const sql = dialect === 'mssql'
    ? 'SELECT TOP 1 id FROM Gouvernements WHERE libelle = :libelle'
    : 'SELECT id FROM Gouvernements WHERE libelle = :libelle LIMIT 1';

  const rows = await queryInterface.sequelize.query(sql, {
    replacements: { libelle },
    type: Sequelize.QueryTypes.SELECT,
  });

  return rows[0]?.id ?? null;
}

const delegationsByGov = {
  'تونس': [
    'قرطاج',
    'المدينة',
    'باب البحر',
    'باب سويقة',
    'العمران',
    'العمران الأعلى',
    'التحرير',
    'المنزه',
    'حي الخضراء',
    'باردو',
    'السيجومي',
    'الزهور',
    'الحرائرية',
    'سيدي حسين',
    'الوردية',
    'الكبارية',
    'سيدي البشير',
    'جبل الجلود',
    'حلق الوادي',
    'الكرم',
    'المرسى',
  ],
  'أريانة': [
    'أريانة المدينة',
    'سكرة',
    'رواد',
    'قلعة الأندلس',
    'سيدي ثابت',
    'حي التضامن',
    'المنيهلة',
  ],
  'منوبة': [
    'منوبة',
    'وادي الليل',
    'طبربة',
    'البطان',
    'الجديدة',
    'المرناقية',
    'برج العامري',
    'دوار هيشر',
  ],
  'بن عروس': [
    'بن عروس',
    'المدينة الجديدة',
    'المروج',
    'حمام الأنف',
    'حمام الشط',
    'بومهل البساتين',
    'الزهراء',
    'رادس',
    'مقرين',
    'المحمدية',
    'فوشانة',
    'مرناق',
  ],
  'نابل': [
    'نابل',
    'دار شعبان الفهري',
    'بني خيار',
    'قربة',
    'منزل تميم',
    'الميدة',
    'قليبية',
    'حمام الأغزاز',
    'الهوارية',
    'تاكلسة',
    'سليمان',
    'منزل بوزلفة',
    'بني خلاد',
    'قرمبالية',
    'بوعرقوب',
    'الحمامات',
  ],
  'بنزرت': [
    'بنزرت الشمالية',
    'جرزونة',
    'بنزرت الجنوبية',
    'سجنان',
    'جومين',
    'ماطر',
    'غزالة',
    'منزل بورقيبة',
    'تينجة',
    'أوتيك',
    'غار الملح',
    'منزل جميل',
    'العالية',
    'رأس الجبل',
  ],
  'زغوان': [
    'زغوان',
    'الزريبة',
    'بئر مشارقة',
    'الفحص',
    'الناظور',
    'صواف',
  ],
  'سوسة': [
    'سوسة المدينة',
    'الزاوية القصيبة الثريات',
    'سوسة الرياض',
    'سوسة جوهرة',
    'سوسة سيدي عبد الحميد',
    'حمام سوسة',
    'أكودة',
    'القلعة الكبرى',
    'سيدي بوعلي',
    'هرقلة',
    'النفيضة',
    'بوفيشة',
    'كندار',
    'سيدي الهاني',
    'مساكن',
    'القلعة الصغرى',
  ],
  'المنستير': [
    'المنستير',
    'الوردانين',
    'الساحلين',
    'زرمدين',
    'بني حسان',
    'جمال',
    'بنبلة',
    'المكنين',
    'البقالطة',
    'طبلبة',
    'قصر هلال',
    'قصيبة المديوني',
    'صيادة لمطة بوحجر',
  ],
  'المهدية': [
    'المهدية',
    'بومرداس',
    'أولاد الشامخ',
    'شربان',
    'هبيرة',
    'السواسي',
    'الجم',
    'الشابة',
    'ملولش',
    'سيدي علوان',
    'قصور الساف',
  ],
  'صفاقس': [
    'صفاقس المدينة',
    'صفاقس الغربية',
    'ساقية الزيت',
    'ساقية الداير',
    'صفاقس الجنوبية',
    'طينة',
    'عقارب',
    'جبنيانة',
    'العامرة',
    'الحنشة',
    'منزل شاكر',
    'الغريبة',
    'بئر علي بن خليفة',
    'الصخيرة',
    'المحرس',
    'قرقنة',
  ],
  'باجة': [
    'باجة الشمالية',
    'باجة الجنوبية',
    'عمدون',
    'نفزة',
    'تبرسق',
    'تيبار',
    'تستور',
    'قبلاط',
    'مجاز الباب',
  ],
  'جندوبة': [
    'جندوبة',
    'جندوبة الشمالية',
    'بوسالم',
    'طبرقة',
    'عين دراهم',
    'فرنانة',
    'غار الدماء',
    'وادي مليز',
    'بلطة بوعوان',
  ],
  'الكاف': [
    'الكاف الغربية',
    'الكاف الشرقية',
    'نبر',
    'الطويرف',
    'ساقية سيدي يوسف',
    'تاجروين',
    'قلعة سنان',
    'القلعة الخصبة',
    'الجريصة',
    'القصور',
    'الدهماني',
    'السرس',
  ],
  'سليانة': [
    'سليانة الشمالية',
    'سليانة الجنوبية',
    'بوعرادة',
    'قعفور',
    'العروسة',
    'الكريب',
    'بورويس',
    'مكثر',
    'الروحية',
    'كسرى',
    'برقو',
  ],
  'القيروان': [
    'القيروان الشمالية',
    'القيروان الجنوبية',
    'الشبيكة',
    'السبيخة',
    'الوسلاتية',
    'حفوز',
    'العلا',
    'حاجب العيون',
    'نصر الله',
    'الشراردة',
    'بوحجلة',
    'عين جلولة',
    'منزل المهيري',
  ],
  'سيدي بوزيد': [
    'سيدي بوزيد الغربية',
    'سيدي بوزيد الشرقية',
    'جلمة',
    'سبالة أولاد عسكر',
    'بئر الحفي',
    'سيدي علي بن عون',
    'منزل بوزيان',
    'المكناسي',
    'سوق الجديد',
    'المزونة',
    'الرقاب',
    'السعيدة',
    'أولاد حفوز',
  ],
  'القصرين': [
    'القصرين الشمالية',
    'القصرين الجنوبية',
    'الزهور',
    'حاسي الفريد',
    'سبيطلة',
    'سبيبة',
    'جدليان',
    'العيون',
    'تالة',
    'حيدرة',
    'فوسانة',
    'فريانة',
    'ماجل بلعباس',
  ],
  'قابس': [
    'قابس المدينة',
    'قابس الغربية',
    'قابس الجنوبية',
    'غنوش',
    'المطوية',
    'منزل الحبيب',
    'الحامة',
    'مطماطة',
    'مطماطة الجديدة',
    'مارث',
    'دخيلة توجان',
  ],
  'مدنين': [
    'مدنين الشمالية',
    'مدنين الجنوبية',
    'بني خداش',
    'بن قردان',
    'جرجيس',
    'جربة حومة السوق',
    'جربة ميدون',
    'جربة أجيم',
    'سيدي مخلوف',
  ],
  'قفصة': [
    'قفصة الشمالية',
    'سيدي عيش',
    'القصر',
    'قفصة الجنوبية',
    'أم العرائس',
    'سيدي بوبكر',
    'الرديف',
    'المتلوي',
    'المظيلة',
    'القطار',
    'بلخير',
    'السند',
    'صانوش',
  ],
  'توزر': [
    'توزر',
    'دقاش',
    'تمغزة',
    'نفطة',
    'حزوة',
    'حامة الجريد',
  ],
  'تطاوين': [
    'تطاوين الشمالية',
    'تطاوين الجنوبية',
    'الصمار',
    'البئر الأحمر',
    'غمراسن',
    'ذهيبة',
    'رمادة',
    'بني مهيرة',
  ],
  'قبلي': [
    'قبلي الجنوبية',
    'قبلي الشمالية',
    'سوق الأحد',
    'دوز الشمالية',
    'دوز الجنوبية',
    'الفوار',
    'رجيم معتوق',
  ],
};

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const now = new Date();

    for (const [gouvLib, delegations] of Object.entries(delegationsByGov)) {
      const gouvId = await findGouvIdByLibelle(queryInterface, Sequelize, gouvLib);
      if (!gouvId) {
        // Gouvernement non trouvé, on passe ces délégations
        continue;
      }

      for (const libelle of delegations) {
        const exists = await rowExists(queryInterface, Sequelize, {
          table: 'Delegations',
          where: { libelle, id_gouvernement: gouvId },
        });

        if (!exists) {
          await queryInterface.bulkInsert('Delegations', [{
            libelle,
            id_gouvernement: gouvId,
            createdAt: now,
            updatedAt: now,
          }], {});
        }
      }
    }
  },

  down: async (queryInterface, Sequelize) => {
    const allDelegations = Object.values(delegationsByGov).flat();
    await queryInterface.bulkDelete('Delegations', { libelle: allDelegations }, {});
  },
};
